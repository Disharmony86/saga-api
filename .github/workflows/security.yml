name: Security Scan - Dependency Check
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '0 3 * * 1'   # Corre cada lunes a las 3 AM (ejemplo profesional)
  workflow_dispatch:       # Permite correrlo manualmente

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      # 1. Descargar código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configurar Java 24
      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'

      # 3. Ejecutar OWASP Dependency-Check
      - name: Run OWASP Dependency Check
        run: mvn org.owasp:dependency-check-maven:check

      # 4. Subir reportes de validacion
      - name: Upload dependency-check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.*

      # 5. Iniciar CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: java

      # 6. Build para análisis
      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      # 7. Análisis de seguridad con CodeQL
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          projectKey: disharmony86
          organization: Disharmony86
          token: ${{ secrets.SONAR_TOKEN }}

